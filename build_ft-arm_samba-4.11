#! /bin/sh

## path to Artix-patch folder for building FT
FT_PATCHES_DIR=$HOME/Dokumente/freshtomato-arm

## path to the FT-repo folder
FT_REPO_DIR=$HOME/freshtomato-arm

## path to modified arm-toolchain
FT_TOOLCHAIN_DIR=$HOME/toolchain-arm2

## path to your local repo of FT-samba4
FT_SAMBA_DIR=$HOME/Dokumente/freshtomato-samba4/arm

## path to extracted libtirpc-sources
LIBTIRPC_DIR=$HOME/Dokumente/freshtomato-samba4/libtirpc-1.2.5

## path to extracted gnutls-sources
GNUTLS_DIR=$HOME/Dokumente/freshtomato-samba4/gnutls-3.6.13

## path to extracted samba-sources
SAMBA_DIR=$HOME/Dokumente/freshtomato-samba4/samba-4.11.9

## toolchain paths
PATH="$PATH:$FT_REPO_DIR/release/src-rt-6.x.4708/toolchains/hndtools-arm-linux-2.6.36-uclibc-4.5.3/bin"

cd $FT_REPO_DIR 
git clean -dxf 
git reset --hard
git checkout arm-master

clear

## Arch-Linux-patches for all builds

patch -i $FT_PATCHES_DIR/common.mak.patch $FT_REPO_DIR/release/src-rt-6.x.4708/router/common.mak
patch -i $FT_PATCHES_DIR/Makefile_arm.patch $FT_REPO_DIR/release/src-rt-6.x.4708/router/Makefile
patch -i $FT_PATCHES_DIR/configure.ac_tor.patch $FT_REPO_DIR/release/src-rt-6.x.4708/router/tor/configure.ac
patch -i $FT_PATCHES_DIR/genconfig.sh.patch $FT_REPO_DIR/release/src-rt-6.x.4708/router/miniupnpd/genconfig.sh
patch -p1 -d$FT_REPO_DIR/release/src-rt-6.x.4708/router/config < $FT_PATCHES_DIR/config_gcc10.patch

## modified arm-toolchain

rm -rf $FT_REPO_DIR/release/src-rt-6.x.4708/toolchains/hndtools-arm-linux-2.6.36-uclibc-4.5.3
cp -rvf $FT_TOOLCHAIN_DIR/hndtools-arm-linux-2.6.36-uclibc-4.5.3 $FT_REPO_DIR/release/src-rt-6.x.4708/toolchains
cp -rvf $FT_REPO_DIR/release/src-rt-6.x.4708/toolchains/hndtools-arm-linux-2.6.36-uclibc-4.5.3/arm-brcm-linux-uclibcgnueabi/sysroot/lib/* $FT_REPO_DIR/release/src-rt-6.x.4708/toolchains/hndtools-arm-linux-2.6.36-uclibc-4.5.3/lib

## stuff / patches for gnutls

rm -rf $FT_REPO_DIR/release/src-rt-6.x.4708/router/gnutls
mkdir $FT_REPO_DIR/release/src-rt-6.x.4708/router/gnutls
cp -rf $GNUTLS_DIR/* $FT_REPO_DIR/release/src-rt-6.x.4708/router/gnutls
rm -f $FT_REPO_DIR/release/src-rt-6.x.4708/router/gnutls/lib/Makefile.in
patch -i $FT_SAMBA_DIR/Makefile_samba_libtirpc_gnutls.patch $FT_REPO_DIR/release/src-rt-6.x.4708/router/Makefile

## stuff for libtirpc

rm -rf $FT_REPO_DIR/release/src-rt-6.x.4708/router/libtirpc
mkdir $FT_REPO_DIR/release/src-rt-6.x.4708/router/libtirpc
cp -rf $LIBTIRPC_DIR/* $FT_REPO_DIR/release/src-rt-6.x.4708/router/libtirpc

## stuff for samba4.11

rm -rf  $FT_REPO_DIR/release/src-rt-6.x.4708/router/samba4
mkdir $FT_REPO_DIR/release/src-rt-6.x.4708/router/samba4
cp -rf $SAMBA_DIR/* $FT_REPO_DIR/release/src-rt-6.x.4708/router/samba4
cp -f $FT_SAMBA_DIR/answer_positiv_arm.txt $FT_REPO_DIR/release/src-rt-6.x.4708/router/samba4/answer.txt
cp -f $FT_SAMBA_DIR/Makefile_samba4.11 $FT_REPO_DIR/release/src-rt-6.x.4708/router/samba4/Makefile
patch -p1 -d$FT_REPO_DIR/release/src-rt-6.x.4708/router/samba4 < $FT_SAMBA_DIR/Bug_14164_ASN1_syntax_error.patch

cd $FT_REPO_DIR/release/src-rt-6.x.4708
#make clean
time make ac68e ## > build.txt; AIO: z; VPN: e

